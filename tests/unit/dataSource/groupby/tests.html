<!DOCTYPE html PUBLIC "//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title> Infragistics jQuery Data Source - filtering QUnit tests </title> 
	<script type="text/javascript" src="../../../../bower_components/jquery/dist/jquery.js"></script>
	<script type="text/javascript" src="../../../../bower_components/jquery-tmpl/jquery.tmpl.js"></script>

	<script type="text/javascript" src="../../../../src/js/modules/infragistics.util.js"></script>
	<script type="text/javascript" src="../../../../src/js/modules/infragistics.datasource.js"></script>
	
	<link type="text/css" href="../../../../bower_components/qunit/qunit/qunit.css" rel="stylesheet" media="screen" />
	<script type="text/javascript" src="../../../../bower_components/qunit/qunit/qunit.js"></script>
	
	<style type="text/css">
		body {
			font-family: Verdana;
			font-size: 11pt;
		}
		
		body table {
			border-width: 1px;
			border-color: green;
			border-style: solid;
			background-color: lightGrey;
		}
		
		body table td,th {
			border: 1px green solid;
		}
	</style>
	
	<script id="tableTemplate" type="text/x-jquery-tmpl">
		<tr> <td> ${Id} </td> <td> ${ProductName} </td> <td> ${ProductDescription} </td>  <td> ${Price} </td> <td> ${Promotion} </td> </tr>
	</script>
	
	<script type="text/javascript"> 
		$(document).ready(function () {
			function renderData(data) {
				var $tbody = $("#t1>tbody");
				$tbody.empty();
				$("#tableTemplate").tmpl(data).appendTo($tbody);
			}
			function generateData(count) {
				var i, count = count || 4, data = [];
				for (i = 0; i < count; i++) {
					data.push({
						Id: i,
						ProductName: "product name " + i,
						ProductDescription: "description " + (i % 2),
						Price: 1,
						Promotion: !!(i % 2)
					});
				}
				return data;
			}
			function createDataSource (dsOpts) {
				dsOpts = dsOpts || { 
					schema: { 
						fields: [
							{ name: "Id", type: "number" }, 
							{ name: "ProductName", type: "string" },
							{ name: "ProductDescription" },
							{ name: "Price" }, 
							{ name: "Promotion", type: "bool" }]
					},
					filtering: { type: "local" }, 
					sorting: { type: "local" }, 
					dataSource: generateData(4)
				};
				return new $.ig.DataSource(dsOpts);
			}
			module("igDataSource groupby basic tests", {
				setup: function () {
				}
			});
			test("Test sorting dataSource for grouped columns", function () {
				var sexprs = [], i, ds = createDataSource(), data, dataView;
				// group by column Id - using defaultFields of sorting
				sexprs.push({
					fieldName: "Id",
					isGroupBy: true,
					dir: "desc"
				});
				ds.settings.sorting.expressions = sexprs;
				ds.settings.sorting.defaultFields = sexprs;
				ds.dataBind();
				data = ds.data();
				dataView = ds.dataView();
				equal(data.length, 4, "Group by Id desc(initial sorting) - Test count of data records");
				equal(dataView.length, data.length * 2, "Group by Id desc(initial sorting) - Test count of dataView records");
				ok(data[0].Id === 3 && data[3].Id === 0, "Group by Id desc(initial sorting) - Test whether properly is sorted data");
				ok(ds.isGroupByApplied(), "Test 'isGroupByApplied'");
				renderData(data);
				// group by for columns Id, ProductName - using sort function
				sexprs.push({
					fieldName: "ProductName",
					isGroupBy: true,
					dir: "desc"
				});
				ds.sort(sexprs);
				data = ds.data();
				dataView = ds.dataView();
				equal(data.length, 4, "Group by Id desc, ProductName desc - Test count of data records");
				equal(ds.dataView().length, data.length * 3, "Group by Id desc, ProductName desc - test count of dataView records");
				ok(dataView[dataView.length - 1].Id === 0 && dataView[0].__gbRecord,
							"Group by Id desc, ProductName desc - test last and first records of dataView");
				ok(data[0].Id === 3 && data[3].Id === 0, "Group by Id desc, ProductName desc - test whether properly is sorted data")
				renderData(data);
				// group by only for column Price
				sexprs = [{
					fieldName: "Price",
					isGroupBy: true,
					dir: "asc"
				},
				{
					fieldName: "Id",
					dir: "asc"
				}];
				ds.sort(sexprs);
				data = ds.data();
				dataView = ds.dataView();
				
				equal(data.length, 4, "Group by column Price and sort by column Id - Test count of data records");
				equal(dataView.length, 5, "Group by column Price and sort by column Id - test count of dataView records");
				ok(data[0].Id === 0 && data[3].Id === 3, 
					"Group by column Price and sort by column Id - test sorting of data records");
				ok(dataView[1].Id === 0 && dataView[0].__gbRecord,
					"Group by Price - test dataView records");
				renderData(data);
			});
			test("Test public functions: 'visibleGroupByData', 'groupByData', 'toggleGroupByRecord'", function () {
				var sexprs = [], i, ds = createDataSource(), data, dataView, gbData;
				sexprs = [{
					fieldName: "Price",
					isGroupBy: true,
					dir: "asc"
				}];
				ds.dataBind();
				ds.sort(sexprs);
				data = ds.data();
				dataView = ds.dataView();
				equal(dataView.length, 5, "Group by Price - test count of dataView records");
				// collapse first row
				ds.toggleGroupByRecord(dataView[0].id, true);
				dataView = ds.dataView();
				ok(ds.isGroupByRecordCollapsed(dataView[0].id) === true, "Test whether first group by record is collapsed");
				equal(dataView.length, 1, "Group by Price - test count of dataView records when first group by record is collapsed");
				ok(dataView[0].__gbRecord && dataView[0].collapsed, "First record in data view should be non-data, group-by record, and propery collapsed should be true");
				ok(ds.visibleGroupByData().length, 1, "Test visibleGroupByData");
				gbData = ds.groupByData();
				equal(gbData.length, 5, "Test groupByData length");
				ok(gbData[0].__gbRecord && gbData[4].Id === 3, 
					"Test groupBy data");
				// expand first row
				ds.toggleGroupByRecord(dataView[0].id, false);
				dataView = ds.dataView();
				equal(dataView.length, 5, "Group by Price - test count of dataView records when first group by record is collapsed");
				ok(dataView[0].__gbRecord && !dataView[0].collapsed, "First record in data view should be non-data, group-by record, and propery collapsed should be true");
				ok(ds.isGroupByRecordCollapsed(dataView[0].id) === false, "Test whether first group by record is expanded");
			});
			test("Test groupby + filtering", function () {
				var sexprs = [], i, ds = createDataSource(), data, dataView, gbData;
				sexprs = [{
					fieldName: "Price",
					isGroupBy: true,
					dir: "asc"
				}];
				ds.settings.sorting.defaultFields = sexprs;
				ds.settings.sorting.expressions = sexprs;
				ds.settings.sorting.enabled = true;
				ds.settings.filtering.defaultFields = [{
					fieldName: "Id",
					cond: "greaterThan",
					expr: 0
				}];
				ds.dataBind();
				dataView = ds.dataView();
				ok(dataView[0].__gbRecord && dataView[3].Id === 3, "Test dataView records");
				equal(dataView.length, 4, "Test count of dataView records");
				renderData(dataView);
			});
			test("Test groupby + paging + filtering", function () {
				var sexprs = [], i, ds = createDataSource(), data, dataView, gbData;
				sexprs = [{
					fieldName: "Id",
					isGroupBy: true,
					dir: "asc"
				}];
				// enable paging
				ds.settings.paging.enabled = true;
				ds.settings.paging.pageSize = 5;
				ds.settings.paging.type = "local";
				// set sorting expressions
				ds.settings.sorting.defaultFields = sexprs;
				ds.settings.sorting.expressions = sexprs;
				ds.settings.sorting.enabled = true;
				ds.settings.filtering.defaultFields = [{
					fieldName: "Id",
					cond: "greaterThan",
					expr: 0
				}];
				ds.dataBind();
				dataView = ds.dataView();
				ok(dataView[0].__gbRecord && dataView[1].Id === 1, "Test dataView records");
				equal(dataView.length, 5, "Test count of records in the dataView");
				equal(ds.groupByData().length, 6, "Test count of records in groupByData");
				equal(ds.pageCount(), 2, "Test pageCount");
				ds.pageIndex(1);
				dataView = ds.dataView();
				ok(dataView.length === 1 && dataView[0].Id === 3, "Test dataView after changing pageIndex to 1");
			});
		});
	</script>
	<!-- <script type="text/javascript" src="../../testswarm/inject.js"></script> -->
</head>
<body>
<div id="div1"></div>
<div style="float:right;width:400px;overflow:auto"">
    <h1 id="qunit-header">Test results</h1>
     <h2 id="qunit-banner"></h2>
     <h2 id="qunit-userAgent"></h2>
     <ol id="qunit-tests"></ol>
</div>

	<table id="t1" cellpadding=5 cellspacing=0>
	<thead>
		<tr> <th>Id</th> <th>ProductName</th> <th>ProductDescription</th>  <th>Price</th> <th>Promotion</th> </tr>
	</thead>
	<tbody>
	
	</tbody>
	</table>


</body>
</html>