<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title> Infragistics jQuery Data Source - Tests for general properties, API methods different than filtering, sorting or paging </title> 
	<script type="text/javascript" src="../../../../bower_components/jquery/dist/jquery.js"></script>
	<script type="text/javascript" src="../../../../bower_components/jquery-mockjax/src/jquery.mockjax.js"></script>

	<script type="text/javascript" src="../../../../src/js/modules/infragistics.util.js"></script>
	<script type="text/javascript" src="../../../../src/js/modules/i18n/infragistics.datasource-en.js"></script>
	<script type="text/javascript" src="../../../../src/js/modules/infragistics.datasource.js"></script>
	
	<link type="text/css" href="../../../../bower_components/qunit/qunit/qunit.css" rel="stylesheet" media="screen" />
	<script type="text/javascript" src="../../../../bower_components/qunit/qunit/qunit.js"></script>
	
	<script type="text/javascript"> 
	 $(function () {
		var dataBindingFired = false, dataBoundFired = false, ds1;
		function loadTestbeds() {
			// define a simple data source control
			ds1 = new $.ig.DataSource();
			ds1.settings.dataBinding = function () { dataBindingFired = true; };
			ds1.settings.dataBound = function () { dataBoundFired = true; };
			ds1.dataBind();
		}
		
		initialized = false;
		module("igDataSource Properties", {
			setup: function() {
				//pause testing until tree is initialized
				if (!initialized) {
					stop();
					loadTestbeds();
					setTimeout(function () { start(); }, 500);
					initialized = true;
				}
			},
			teardown: function() {
			}
		});
			
		test("igDataSource events test: DataBinding", function() {
			
			equal(true, dataBindingFired, true);
		});
		
		test("igDataSource events test: DataBound", function() {

			equal(true, dataBoundFired, true);
		});
		
		test("igDataSource properties test: fields property", function () {
		
			var fields = ds1.fields([{name: "test1"}, {name: "test2"}]).fields();
			equal(2, fields.length, 2);
			
		});
		
		test("igDataSource properties test: Schema property", function () {
		
			var schema = ds1.schema({type:"unknown"}).schema();
			equal("unknown", schema._type, "unknown");
		});
		
		test("igDataSource properties test: paging settings property", function () {
			
			var ps = ds1.pagingSettings({pageSize: 5}).pagingSettings();
			equal(5, ps.pageSize, 5);
			
		});
		
		test("igDataSource properties test: filtering settings property", function () {
		
			var fs = ds1.filterSettings({filterExprUrlKey: "f"}).filterSettings();
			equal("f", fs.filterExprUrlKey, "f");
		});
		
		test("igDataSource properties test: sort settings property", function () {
		
			var ss = ds1.sortSettings({exprString: "col1 ASC"}).sortSettings();
			equal("col1 ASC", ss.exprString, "col1 ASC");
		});
		
		
		test("igDataSource properties test: dataSource property test", function () {
		
			var ds = ds1.dataSource("http://www.infragistics.com").dataSource();
			equal("http://www.infragistics.com", ds, "http://www.infragistics.com");
		});
	
		test("igDataSource properties test: type property test", function () {
		
			var t = ds1.type("unknown").type();
			if ((t === "unknown" || t === "empty") && t !== undefined && t != null) {
				ok (true, "type is ok", true);
			} else {
				ok(false, "type is not ok", false);
			}
			equal("unknown", ds1.settings.type, "unknown");
		});
		
		// page index
		test("igDataSource properties test: page index property", function () {
			
			var ps = ds1.pagingSettings({pageSize: 5}).pagingSettings();
			equal(0, ds1.pageIndex(), 0);
			
		});
		
		// page count
		test("igDataSource properties test: page count property", function () {
			
			var ps = ds1.pagingSettings({pageSize: 5}).pagingSettings();
			equal(1, ds1.pageCount(), 1);
		});	

		// test stringToJSONObject
		test("Test stringToJSONObject", function () {
			var obj = ds1.stringToJSONObject('{"p": 5}');
			ok(obj.p === 5, "Test stringToJSONObject");
			throws(
				function () {
					ds1.stringToJSONObject('{"p": 5');
				},
				function (err) {
					return err.message.indexOf($.ig.DataSourceLocale.locale.errorParsingJsonNoSchema) > -1;
				},
				$.ig.DataSourceLocale.locale.errorParsingJsonNoSchema + " should be thrown"
			);
		});
		
		test("Test creating JSONDataSource", function () {
			 var adventureWorks = {
                "Records": [{
                    "ProductID": 1,
                    "Name": "Adjustable Race",
                    "ProductNumber": "AR-5381"
                }, {
                    "ProductID": 2,
                    "Name": "Bearing Ball",
                    "ProductNumber": "BA-8327"
                }
            ]};
			 var jsonpDs = new $.ig.JSONDataSource({
                        dataSource: adventureWorks,
                        responseDataKey: "Records"
                    });
 
            jsonpDs.dataBind();
			equal(jsonpDs.type(), "json", "Check if dataSource type is correct.");
			equal(jsonpDs.dataView().length, 2, "DataView should contain 2 records.");
			
			jsonpDs = new $.ig.JSONDataSource();

			equal(jsonpDs.type(), "json", "Check if dataSource type is correct.");
		});
		
		test("Test creating HtmlTableDataSource ", function () {
			var htmltableDs = new $.ig.HtmlTableDataSource ();
			equal(htmltableDs.type(), "htmlTableDom", "Check if dataSource type is correct.");
		});
		
		test("Test creating ArrayDataSource  ", function () {
			var arrayDs = new $.ig.ArrayDataSource();
			equal(arrayDs.type(), "array", "Check if dataSource type is correct.");
		});
		
		test("Test creating RemoteDataSource   ", function () {
			var arrayDs = new $.ig.RemoteDataSource ();
			equal(arrayDs.type(), "remoteUrl", "Check if dataSource type is correct.");
		});
		
		test("Test creating JSONPDataSource", function () {
			var JSONPDataSource = new $.ig.JSONPDataSource  ();
			equal(JSONPDataSource.settings.responseDataType , "jsonp", "Check if responseDataType is correct.");
		});
		
		test("Test creating XmlDataSource ", function () {
			var xmlds  = new $.ig.XmlDataSource();
			equal(xmlds.type(), "xml", "Check if dataSource type is correct.");
		});
		
		test("Test creating FunctionDataSource", function () {
			var funcDs  = new $.ig.FunctionDataSource ();
			equal(funcDs.type(), "function", "Check if dataSource type is correct.");
		});

		var dsSummaries, dsLocal, hierarchicalDS;
		function loadAPITestbeds() {
			var data = [
				{ "ID": 0, "Name": "Bread", "Price": 2.5 },
				{ "ID": 1, "Name": "Milk", "Price": 3.5 },
				{ "ID": 2, "Name": "Vint soda", "Price": 20.9 }
			];

			var jsonData = [{
				"ID": 0,
				"Name": "Food",
				"Category": { "d": [{ "ID": 0, "Name": "Food", "Active": true, "Date": "\/Date(1059660800000)\/" }] },
				"Products": [
                    { "ID": 0, "Name": "Bread", "Price": "2.5" }
				]
			},
		{
			"ID": 1,
			"Name": "Beverages",
			"Category": { "d": [{ "ID": 2, "Name": "Beverages", "Active": true, "Date": "\/Date(1159660800000)\/" }] },
			"Products": [
				{ "ID": 1, "Name": "Milk", "Price": "3.5" },
				{ "ID": 2, "Name": "Vint soda", "Price": "20.9" }
			]
		},
		{
			"ID": 2,
			"Name": "Electronics",
			"Category": { "d": [{ "ID": 5, "Name": "Electronics", "Active": false, "Date": "\/Date(1859660800000)\/" }] },
			"Products": [
				{ "ID": 7, "Name": "DVD Player", "Price": "35.88" },
				{ "ID": 8, "Name": "LCD HDTV", "Price": "1088.8" }
			]
		}];

			dsSummaries = new $.ig.DataSource({
				dataSource: data,
				schema: {
					fields: [{
						name: "Name"
					}, {
						name: "Price"
					}, {
						name: "Rating"
					}]
				},
				summaries: {
					type: "local",
					columnSettings: [{
						columnKey: "Price",
						allowSummaries: true,
						summaryOperands: [{
							type: "count",
							active: true,
							order: 0
						}]
					}]
				}, 
				paging: {type: "local", pageSize:1}
			});
			
			dsSummaries.dataBind();

			dsLocal = new $.ig.DataSource({
				dataSource: data,
				primaryKey: "ID",
				schema: {
					fields: [
					{
						name: "ID"
					},
					{
						name: "Name"
					}, {
						name: "Price"
					}, {
						name: "Rating"
					}]
				},
				summaries: {
					type: "local"
				}, 
				paging: {type: "local", enabled:true},
				filtering: { type: "local", defaultFields: [], enabled: true },
				sorting: { type: "local", defaultFields: [], applyToAllData: true, enabled: true, expressions:[] }
			});
			
			dsLocal.dataBind();

			hierarchicalDS = new $.ig.DataSource({
				dataSource: jsonData,
				primaryKey: "ID",
				defaultChildrenDataProperty: "Products",
				schema: {
					fields: [
					{
						name: "ID"
					},
					{
						name: "Name"
					}
					],
					layouts: {
						"/Products": {
							key: "Products",
							fields: [
							{
								name: "ID"
							},
							{
								name: "Name"
							}
							]
						},
						"/Category": {
							responseDataKey: "d",
							key: "Category",
							fields: [
							{
								name: "ID"
							},
							{
								name: "Name"
							}
							]
						}
					}
				}
			});

			hierarchicalDS.dataBind();
		}

		isInitialized = false;
		module("igDataSource API Methods", {
			setup: function () {
				//pause testing until data source is initialized
				if (!isInitialized) {
					stop();
					loadAPITestbeds();
					setTimeout(function () { start(); }, 500);
					isInitialized = true;
				}
			},
			teardown: function () {
			}
		});

		test("Test clearLocalSorting/clearLocalFilter API methods", function () {
			var dsLocalOperations = new $.ig.DataSource({
				dataSource: [
				{ "ID": 0, "Name": "Bread", "Price": 2.5 },
				{ "ID": 1, "Name": "Milk", "Price": 3.5 },
				{ "ID": 2, "Name": "Vint soda", "Price": 20.9 }
				],
				primaryKey: "ID",
				schema: {
					fields: [
					{
						name: "ID"
					},
					{
						name: "Name"
					}, {
						name: "Price"
					}, {
						name: "Rating"
					}]
				},
				summaries: {
					type: "local"
				},
				paging: { type: "local", enabled: true },
				filtering: { type: "local", defaultFields: [], enabled: true },
				sorting: { type: "local", defaultFields: [], applyToAllData: true, enabled: true, expressions: [] }
			});

			dsLocalOperations.dataBind();
			stop();
			setTimeout(function () {
				start();
				dsLocalOperations.sort([{ fieldName: "ID" }], "desc", false);
				dsLocalOperations.filter([{ fieldName: "ID", expr: 2, cond: "lessThan" }], "AND", true);

				dsLocalOperations.pageSize(1);
				dsLocalOperations.pageIndex(2);

				equal(dsLocalOperations.dataView().length, 1, "There should be 1 record in the dataView.");
				equal(dsLocalOperations.dataView()[0].ID, 1, "Data should be sorted in descending order - top record should be with ID:1");
				equal(dsLocalOperations.filteredData().length, 2, "Filtered data should contain 2 records.");

				dsLocalOperations.clearLocalFilter();

				equal(dsLocalOperations.filteredData().length, 1, "Filtered data should contain 1 record.");
				
				dsLocalOperations.filter([{ fieldName: "ID", expr: 2, cond: "lessThan" }], "AND", true);

				dsLocalOperations.clearLocalSorting();

				equal(dsLocalOperations.settings.sorting.expressions.length, 0, "There should be no expressions for sorting after clearLocalSorting is called.");
			}, 500);
		});

		test("Test dataSummaries API method", function () {
			var summariesData = dsSummaries.dataSummaries();
			equal(summariesData, dsSummaries.dataView(), "When local summaries are enabled the data.")
		});

		test("Test summariesSettings API method", function () {
			var summariesSettings = dsSummaries.summariesSettings();
			equal(summariesSettings, dsSummaries.settings.summaries, "summariesSettings API method should return the current summary settings.");
			var newSettings = { type: "local" };
			dsSummaries.summariesSettings(newSettings);
			equal(dsSummaries.settings.summaries, newSettings, "Verify that settings have been applied.");

		});

		test("Test addRow when rowAdded option is defined", function () {
			var rowAddedFuncCalled = false;
			dsLocal.settings.callee = function () {
			};

			dsLocal.settings.rowAdded = function(){
				rowAddedFuncCalled= true;
			};
			dsLocal.addRow(100, { "ID": 100, "Name": "Bread", "Price": 2.5 }, true);

			stop();

			setTimeout(function(){
				//check when there is a callback func
				ok(rowAddedFuncCalled, "The rowAdded function should be called.");

				dsLocal.settings.callee = null;
				rowAddedFuncCalled = false;
				dsLocal.addRow(101, { "ID": 100, "Name": "Bread", "Price": 2.5 }, true);

				setTimeout(function(){
					start();
					//check when there is no callback func
					ok(rowAddedFuncCalled, "The rowAdded function should be called.");
				},100);

			}, 100);


		});

		test("Test deleteRow when rowDeleted option is defined", function () {
			rowDeletedFuncCalled = false;
			dsLocal.settings.aggregateTransactions = false;

			dsLocal.settings.callee = function () {
			};
			dsLocal.settings.rowDeleted = function () {
				rowDeletedFuncCalled = true;
			};

			dsLocal.deleteRow(101, true);
			stop();
			setTimeout(function () {
				ok(rowDeletedFuncCalled, "rowDeleted function should be called.");
				rowDeletedFuncCalled = false;
				dsLocal.settings.callee = null;
				dsLocal.deleteRow(100, true);
				setTimeout(function () {
					start();
					ok(rowDeletedFuncCalled, "rowDeleted function should be called.")
				}, 100);
			}, 100);

		});

		test("Test insertRow when rowInserted option is defined", function () {
			rowInsertedFuncCalled = false;

			dsLocal.settings.callee = function () {
			};
			dsLocal.settings.rowInserted = function () {
				rowInsertedFuncCalled = true;
			};

			dsLocal.insertRow(1001, { "ID": 1001, "Name": "Bread", "Price": 2.5 }, 2, false);
			stop();
			setTimeout(function () {
				ok(rowDeletedFuncCalled, "rowInserted function should be called.");
				rowInsertedFuncCalled = false;
				dsLocal.settings.callee = null;
				dsLocal.insertRow(1001, { "ID": 1001, "Name": "Bread", "Price": 2.5 }, 2, false);
				setTimeout(function () {
					start();
					ok(rowInsertedFuncCalled, "rowInserted function should be called.")
				}, 100);
			}, 100);
		});

		test("Test updateRow when rowUpdated option is defined", function () {
			rowUpdatedFuncCalled = false;

			dsLocal.settings.callee = function () {
			};
			dsLocal.settings.rowUpdated = function () {
				rowUpdatedFuncCalled = true;
			};

			dsLocal.updateRow(1001, { "ID": 1001, "Name": "Update", "Price": 2.5 }, false);
			stop();
			setTimeout(function () {
				ok(rowDeletedFuncCalled, "rowInserted function should be called.");
				rowUpdatedFuncCalled = false;
				dsLocal.settings.callee = null;
				dsLocal.updateRow(1001, { "ID": 1001, "Name": "Updated2", "Price": 2.5 }, false);
				setTimeout(function () {
					start();
					ok(rowUpdatedFuncCalled, "rowInserted function should be called.")
				}, 100);
			}, 100);
		});

		test("Test commit API method - commit all", function () {
			equal(dsLocal.pendingTransactions().length, 2, "Pending transactions should be 2.");
			dsLocal.commit();
			equal(dsLocal.pendingTransactions().length, 0, "Pending transactions should be empty.");

		});

		test("Test adding row for child layout - schema.layouts", function () {
			stop();
			setTimeout(function () {
				hierarchicalDS.addRow(200, { "ID": 200, "Name": "Food200" }, true);
				start();
				var newRec = hierarchicalDS.data()[hierarchicalDS.data().length - 1];
				ok(newRec.ID === 200 &&  Array.isArray(newRec.Category.d) && Array.isArray(newRec.Products), "Verify that the child layout collections are created in the new record.");
			}, 100);
		
		});

		test("Test rollback API method - rollback transaction by id", function () {

			var transaction = dsLocal.addRow(999, { "ID": 999, "Name": "Bread", "Price": 2.5 }, false);

			equal(dsLocal.pendingTransactions().length, 1, "There should be a single pending transaction.");

			dsLocal.rollback(transaction.rowId);

			equal(dsLocal.pendingTransactions().length, 0, "There should be a no pending transaction after the transaction has been rolled back.");
		});

		test("Test _removeTransactionsByRecordId API", function () {
			dsLocal.addRow(998, { "ID": 998, "Name": "Bread", "Price": 2.5 }, false);
			dsLocal.addRow(999, { "ID": 999, "Name": "Bread", "Price": 2.5 }, false);
			
			dsLocal._removeTransactionsByRecordId(999);
			equal(dsLocal.pendingTransactions().length, 1, "There should be 1 pending transaction after one transaction has been removed.");
			equal(dsLocal.pendingTransactions()[0].row.ID, 998, "There should be 1 transaction remaining for row with ID 998.");
			
			dsLocal._removeTransactionsByRecordId(998);
			equal(dsLocal.pendingTransactions().length, 0, "There should no pending transaction the transaction has been removed.");
		});

		test("Test transactionsAsString API", function () {
			dsLocal.allTransactions().clear();
			var t = dsLocal.addRow(999, { "ID": 999, "Name": "Bread", "Price": 2.5 }, false);
			var transactions = dsLocal.transactionsAsString();
			equal(transactions, '[{"type":"newrow","tid":"' + t.tid + '","row":{"ID":999,"Name":"Bread","Price":2.5},"rowId":999}]', "transactionsAsString should return all transactions parsed to string.");

		});

		test("Test saveChanges API method - success", function () {
			var callBackCalled = false;
			var customCallBackCalled = false;
			$.mockjax({
				url: 'updateSuccess',
				responseText: {
					Success: true
				}
			});
			dsLocal.allTransactions().clear();
			dsLocal.settings.updateUrl = "updateSuccess";


			function successCallbackFunc() { 
				callBackCalled = true;
			}
			dsLocal._addChangesSuccessHandler(successCallbackFunc);

			dsLocal.addRow(999, { "ID": 999, "Name": "Bread", "Price": 2.5 }, true);

			equal(dsLocal.allTransactions().length, 1, "There should be a single unsaved transaction.");

			dsLocal.saveChanges(function () { customCallBackCalled = true; });
			stop();

			setTimeout(function () {
				start();
				equal(dsLocal.allTransactions().length, 0, "There should be no unsaved transactions after saveChanges is called and the request is successful.");
				ok(callBackCalled, "Success callback should be called.");
				ok(customCallBackCalled, "Custom Success callback should be called.")
			}, 500);
		});



		test("Test saveChanges API method - error", function () { 
			var callBackCalled = false;
			var customCallBackCalled = false;

			function errorCallbackFunc() {
				callBackCalled = true;
			}
			dsLocal._addChangesErrorHandler(errorCallbackFunc);

			$.mockjax({
				url: 'updateFail',
				responseText: {
					Success: false
				}
			});
			dsLocal.allTransactions().clear();
			dsLocal.settings.updateUrl = "updateFail";

			dsLocal.addRow(999, { "ID": 999, "Name": "Bread", "Price": 2.5 }, true);

			equal(dsLocal.allTransactions().length, 1, "There should be a single unsaved transaction.");

			dsLocal.saveChanges(function () { }, function () { customCallBackCalled = true; });
			stop();

			setTimeout(function () {
				equal(dsLocal.allTransactions().length, 1, "There should still be a single unsaved transactions.");
				ok(callBackCalled, "Error callback should be called.");
				ok(customCallBackCalled, "Custom Error callback should be called.");

				dsLocal.settings.updateUrl = "updateFail2";
				callBackCalled = false;
				customCallBackCalled = false;
				dsLocal.saveChanges(function () { }, function () { customCallBackCalled = true; });
				setTimeout(function () {
					start();
					equal(dsLocal.allTransactions().length, 1, "There should still be a single unsaved transactions.");
					ok(callBackCalled, "Error callback should be called.");
					ok(customCallBackCalled, "Custom Error callback should be called.");
				},100);

			}, 500);
		
		});

		test("Test getDetachedRecord API method", function () {
			var arrayData = [
				[0, "Bread", 2.5],
				[1, "Milk", 3.5],
				[2, "Vint soda", 20.9]
			];
			dsLocal.settings.localSchemaTransform = false;
			dsLocal.settings.dataSource = arrayData;
			dsLocal.settings.primaryKey = null;

			dsLocal.dataBind();
			stop();

			setTimeout(function () {
				start();
				var t = dsLocal.setCellValue(0, "Name", "NewVal", true);
				var rec = dsLocal.getDetachedRecord(t);
				dsLocal.setCellValue(0, "Name", "NewVal123", true);
				
				equal(rec.Name, "NewVal", "Detached value should be updated.");

				dsLocal.settings.primaryKey = "ID";

				var t2 = dsLocal.addRow(3, [3, "New Rec", 20.9], true);
				var rec2 = dsLocal.getDetachedRecord(t2);
				equal(rec2[1], "New Rec", "Detached value should be updated.");

			}, 200);
		});

		test("Test remote summaries - encoded summaries params", function () {
			dsSummaries.settings.dataSourceUrl = "getRemoteSummaries";
			dsSummaries.settings.summaries = {
				type: "remote",
				summaryExprUrlKey: "summaries",
				columnSettings: [{
					columnKey: "Price",
					allowSummaries: true,
					summaryOperands: [{
						type: "count",
						active: true,
						order: 0
					}]
				}]
			};
			stop();
			setTimeout(function () {
				start();
				var params = $.param(dsSummaries._encodeUrl());
				equal(params, "summaries(Price)=count");
			}, 200);
		});
		
		test("Test binding to remote xml data when no schema is defined.", function () { 
			var xmlString = '<Response><Item><Name>Item1</Name></Item><Item><Name>Item2</Name></Item><Item><Name>Item3</Name></Item></Response>';

			$.mockjax({
				url: 'getXMLDataSummaries',
				responseText: xmlString
			});

			var dsSummariesRemote = new $.ig.DataSource({
				//responseDataKey: "data",
				dataSource: "getXMLDataSummaries",
				summaries: {
					type: "remote",
					columnSettings: [{
						columnKey: "song",
						allowSummaries: true,
						summaryOperands: [{
							type: "count",
							active: true,
							order: 0
						}]
					}]
				}, 
				paging: { type: "remote", enabled:true, appendPage:true}
			});

			dsSummariesRemote.dataBind();
			stop();
			setTimeout(function () {
				start();
				var currData = dsSummariesRemote.data();
				equal(currData.length, 3, "Check if data length is correct. There should be 3 records.");
				equal(currData[0].Name, "Item1", "Check if value is correctly parsed.");
			}, 500);
		});
		test("Test binding to remote - error", function () {
			var errorMessage = "";
			var dsRemote = new $.ig.DataSource({
				dataSource: "invalidUrl",
				callback: function (success, error) {
					if (!success) { 
						errorMessage = error;
					}
				},
				schema: {
					fields: [{ name: "song", xpath: "@title" }, { name: "artist", xpath: "Artist" }]
				}
			});
			dsRemote.dataBind();

			stop();
			setTimeout(function () { 
				start();
				equal(errorMessage, "The remote request to fetch data has failed:  ( error ) ", "An error message with the correct text should be returned.");
			}, 500);
		});

	});
	</script>
	
</head>
<body>
<div id="div1"></div>
<div style="float:right;width:400px;overflow:auto">
    <h1 id="qunit-header">Test results</h1>
     <h2 id="qunit-banner"></h2>
     <h2 id="qunit-userAgent"></h2>
     <ol id="qunit-tests"></ol>
</div>

</body>
</html>